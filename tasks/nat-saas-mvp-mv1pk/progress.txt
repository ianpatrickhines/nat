# Ralph Progress Log - nat-saas-mvp
Started: 2025-01-12
---

## 2025-01-12 - US-001: CloudFormation base infrastructure

**Implementation:**
- Created `infrastructure/template.yaml` with CloudFormation resources
- Tenants table: tenant_id PK, stripe_customer_id GSI, PAY_PER_REQUEST, PITR enabled
- Users table: user_id PK, tenant_id GSI, email GSI, PAY_PER_REQUEST, PITR enabled
- Lambda execution role with policies for DynamoDB (CRUD on both tables + indexes) and Secrets Manager (nat/* secrets)
- All stateful resources have DeletionPolicy: Retain
- Added `pyproject.toml` with mypy and cfn-lint configuration

**Learnings:**
- Project has pre-existing Python code in src/nat/ with type issues - future stories should not break existing mypy
- cfn-lint is the preferred way to validate CloudFormation in this project
- Template exports table names/ARNs and role ARN for cross-stack references

## 2025-01-12 - US-002: API Gateway REST API setup

**Implementation:**
- Added API Gateway REST API (`nat-api-${Environment}`) to `infrastructure/template.yaml`
- Created `/health` endpoint with MOCK integration returning `{"status": "healthy"}` and 200 OK
- Configured CORS headers on health endpoint (GET + OPTIONS preflight)
- Added GatewayResponse resources for CORS headers on 4XX and 5XX error responses
- CORS allows all origins (`*`) with standard headers + custom `X-Nat-User-Id`, `X-Nat-Tenant-Id`
- Added deployment and stage resources for environment-specific URLs
- Exported API Gateway ID, Root Resource ID, API URL, and Health Check URL

**Learnings:**
- API Gateway MOCK integrations can't use CloudFormation `${Variable}` substitution in response templates - they're runtime templates
- GatewayResponse resources are required for CORS headers on error responses (4XX/5XX)
- Custom domain parameter left commented out as placeholder - will need ACM certificate and Route 53 for full implementation
- OPTIONS preflight methods required for each resource that will receive cross-origin requests

## 2025-01-12 - US-003: Stripe webhook Lambda

**Implementation:**
- Created `src/lambdas/stripe_webhook/handler.py` with full Lambda handler
- Webhook signature verification using HMAC-SHA256 with timestamp tolerance (5 min)
- `checkout.session.completed`: Creates tenant record with plan, query limits, billing cycle; creates initial admin user
- `customer.subscription.updated`: Updates subscription status, plan, query limits; resets usage count on new billing cycle
- `customer.subscription.deleted`: Marks subscription as cancelled
- CloudFormation: Lambda function, Lambda permission, `/stripe/webhook` API Gateway resource with POST + OPTIONS
- Webhook secret retrieved from Secrets Manager (`nat/stripe-webhook-secret-${Environment}`)
- 22 unit tests covering all event handlers, signature verification, edge cases

**Learnings:**
- Stripe signature header can be `Stripe-Signature` or `stripe-signature` depending on API Gateway configuration - handle both
- DynamoDB GSI queries return list even for single matches - always check `Items` array
- Plan name can be inferred from Stripe price_id if explicit mapping not configured
- mypy strict mode requires explicit type annotations for all variables even when obviously string (e.g., `secret: str = response.get("SecretString", "")`)
- Lambda ZipFile in CloudFormation is placeholder only - actual code deployed separately via CI/CD

## 2025-01-12 - US-004: Subscription verification middleware

**Implementation:**
- Created `src/lambdas/shared/subscription_middleware.py` as reusable middleware
- Extracts user identity from `X-Nat-User-Id` and `X-Nat-Tenant-Id` headers (case-insensitive)
- Looks up user in Users table to get tenant_id if not provided in headers
- Checks tenant subscription status - allows `active` and `trialing` statuses
- Returns 401 Unauthorized if user header missing or user not found
- Returns 402 Payment Required if subscription is inactive (cancelled/past_due/unpaid)
- Returns 403 Forbidden if query limit exceeded (queries_this_month >= queries_limit)
- Supports decorator pattern via `@SubscriptionMiddleware()` for Lambda handlers
- Added `src/__init__.py` and `src/lambdas/__init__.py` for proper module structure
- 26 unit tests covering all error cases and success paths

**Learnings:**
- mypy `--explicit-package-bases` flag needed to avoid "module found twice" errors with nested packages
- API Gateway may lowercase headers - normalize to lowercase for comparison
- TypedDict is useful for documenting Lambda response structure while maintaining dict compatibility
- Decorator pattern allows clean integration with existing Lambda handlers while providing error handling

## 2025-01-12 - US-005: NationBuilder OAuth callback Lambda

**Implementation:**
- Created `src/lambdas/nb_oauth_callback/handler.py` with full OAuth callback handler
- Receives OAuth callback with authorization code and base64-encoded state parameter
- State contains: user_id, nb_slug, redirect_uri for reconstructing the flow
- Exchanges authorization code for access_token and refresh_token via NB token endpoint
- Stores tokens in Secrets Manager at `nat/user/{user_id}/nb-tokens` with metadata (expires_at, nb_slug)
- Updates user record: nb_connected=true, nb_slug, nb_token_expires_at, nb_needs_reauth=false
- Returns 302 redirect to success page on success, error page with error query param on failure
- CloudFormation: Lambda function + `/auth/nationbuilder/callback` GET endpoint with CORS
- 15 unit tests covering success flow, error handling, edge cases

**Learnings:**
- NB OAuth tokens endpoint expects form-encoded POST body, not JSON
- State parameter is base64-encoded JSON to pass user context through OAuth redirect flow
- Token exchange uses urllib3 directly since boto3 doesn't have HTTP client
- Secrets Manager `put_secret_value` raises `ResourceNotFoundException` if secret doesn't exist - need fallback to `create_secret`
- OAuth callback returns redirect (302) not JSON - browser handles redirect automatically

## 2025-01-12 - US-006: Token refresh Lambda with EventBridge

**Implementation:**
- Created `src/lambdas/token_refresh/handler.py` with full token refresh logic
- Scans Users table for tokens expiring in next 12 hours (configurable via TOKEN_EXPIRY_WINDOW_HOURS)
- Filter: nb_connected=true AND nb_needs_reauth!=true AND nb_token_expires_at <= window_end
- Refreshes tokens via NB OAuth token endpoint with grant_type=refresh_token
- Stores new tokens in Secrets Manager (NB refresh tokens are single-use, so new refresh_token must be saved)
- Updates user record with new nb_token_expires_at on success
- Sets nb_needs_reauth=true on failure (user will see "Reconnect" in extension)
- CloudFormation: Lambda function (5 min timeout) + EventBridge rule with rate(12 hours) schedule
- Handler returns summary: processed count, succeeded count, failed count, failure details
- 18 unit tests covering all paths: success, no tokens, no refresh_token, API failure, batch processing

**Learnings:**
- NB refresh tokens are single-use - new refresh_token in response must be stored to replace old one
- DynamoDB scan FilterExpression uses Attr() for attribute conditions (from boto3.dynamodb.conditions)
- EventBridge rule uses AWS::Events::Rule with ScheduleExpression: 'rate(12 hours)'
- Lambda permission for EventBridge uses Principal: events.amazonaws.com with SourceArn pointing to rule
- Pagination handling needed for DynamoDB scan (LastEvaluatedKey/ExclusiveStartKey)
- Lambda timeout increased to 300s to handle many users in single invocation

## 2025-01-12 - US-007: Port Nat agent to Lambda

**Implementation:**
- Created `src/lambdas/nat_agent/handler.py` Lambda handler for AI agent queries
- Handler receives query and optional page context (page_type, person_name, person_id, list_name, event_name)
- Extracts user_id from request body or X-Nat-User-Id header
- Verifies user exists, has nb_connected=true, and nb_needs_reauth=false before processing
- Retrieves NB tokens from Secrets Manager at `nat/user/{user_id}/nb-tokens`
- Uses existing `create_nat_options()` from src/nat/agent.py to configure Claude SDK with all 66 tools
- Returns JSON response with `response` (text) and `tool_calls` (list of tool invocations)
- Error handling returns appropriate HTTP codes: 400 (bad request), 403 (NB not connected), 404 (user not found), 500 (agent error)
- CloudFormation: Lambda function (120s timeout, 512MB memory) + POST /agent/query endpoint with CORS
- 23 unit tests covering API key retrieval, token retrieval, user info, and handler flows

**Learnings:**
- Lambda imports should be done inside handler functions to avoid cold start issues with large packages like claude_agent_sdk
- mypy requires explicit type annotations for DynamoDB response.get("Item") to avoid "Returning Any" errors
- asyncio.get_event_loop().run_until_complete() bridges sync Lambda handler with async Claude SDK
- Page context allows agent to be aware of what user is viewing (person profile, list, event) for context-aware responses
- Error codes (NB_NOT_CONNECTED, NB_NEEDS_REAUTH, NB_TOKENS_MISSING, AGENT_ERROR) help extension show appropriate UI

## 2025-01-12 - US-008: SSE streaming response handler

**Implementation:**
- Created `src/lambdas/nat_agent_streaming/handler.py` for SSE streaming responses
- Uses Lambda Function URL with RESPONSE_STREAM invoke mode for true streaming (API Gateway doesn't support SSE streaming)
- SSE event types: `text` (partial response chunks), `tool_use` (tool invocations), `tool_result` (results), `error`, `done`
- `done` event includes complete response text and array of all tool_calls for client state management
- CloudFormation adds NatAgentStreamingFunction (120s timeout, 512MB) + NatAgentStreamingUrl with CORS
- Lambda URL configured with AuthType: NONE and CORS for Chrome extension access
- Standard handler() for non-streaming invocation (testing), streaming_handler() for actual streaming
- 25 unit tests covering SSE formatting, request validation, error cases, and handler flows

**Learnings:**
- Lambda Function URLs with RESPONSE_STREAM invoke mode are required for true SSE streaming - API Gateway doesn't support it
- AWS::Lambda::Url resource with InvokeMode: RESPONSE_STREAM enables response streaming
- Lambda URL permission requires `lambda:InvokeFunctionUrl` action, not `lambda:InvokeFunction`
- FunctionUrlAuthType in permission must match AuthType in URL config
- SSE format: `event: {type}\ndata: {json}\n\n` - double newline terminates event
- Async generator pattern works well for streaming: `async for event in process_streaming_request(body):`
- pytest async tests without pytest-asyncio can use run_async() helper with asyncio.get_event_loop().run_until_complete()

## 2025-01-12 - US-009: Usage tracking and rate limiting

**Implementation:**
- Created `src/lambdas/shared/usage_tracking.py` with core functions:
  - `check_rate_limit()`: Enforces 5-second cooldown per user, raises RateLimitError with retry_after
  - `update_last_query_time()`: Updates user's last_query_at timestamp
  - `increment_query_count()`: Atomic increment of tenant's queries_this_month using DynamoDB conditional update
  - `check_and_reset_billing_cycle()`: Checks if billing cycle has started and resets usage counter
  - `track_query_usage()`: Convenience function that updates time and increments count
- Added RATE_LIMIT_EXCEEDED to SubscriptionErrorCode enum in subscription middleware
- Integrated into nat_agent handler: rate check before query, usage tracking after success
- Integrated into nat_agent_streaming handler: rate check before streaming, usage tracking after done event
- Added TENANTS_TABLE environment variable to NatAgentFunction and NatAgentStreamingFunction in CloudFormation
- 20 unit tests covering all functions, edge cases, and Decimal handling

**Learnings:**
- DynamoDB returns Decimal types for numbers - need to convert to int for comparisons
- Atomic increment uses `SET queries_this_month = if_not_exists(queries_this_month, :zero) + :inc`
- Rate limiting "fails open" on errors - don't block users due to DynamoDB issues
- Usage tracking happens AFTER successful query to avoid charging for failed requests
- For streaming, need to detect success by checking done event without error
- Retry-After header in 429 response helps clients implement proper backoff
## 2025-01-12 - US-010: Chrome extension scaffold

**Implementation:**
- Created `extension/` directory with complete Manifest V3 Chrome extension scaffold
- `public/manifest.json` - Manifest V3 with storage/activeTab permissions, host_permissions for *.nationbuilder.com
- `vite.config.ts` - Builds content.js and background.js, copies manifest.json and content.css to dist
- `tsconfig.json` - TypeScript strict mode with Preact JSX config and @types/chrome
- `src/content/index.tsx` - Entry point that injects sidebar container on NB pages
- `src/components/Sidebar.tsx` - Preact component with open/collapsed states (350px/40px)
- `src/content/content.css` - Scoped CSS with maximum z-index and style reset to avoid NB conflicts
- `src/background/index.ts` - Service worker with auth state management and message passing
- Build produces: content.js (13.99kb), background.js (0.80kb), content.css, manifest.json

**Learnings:**
- Manifest V3 uses service workers instead of background pages - no persistent state
- chrome.storage.local is the correct place for auth tokens in MV3 (not localStorage)
- Content scripts need CSS isolation - using `all: initial` and high z-index prevents NB style conflicts
- Vite custom plugin for closeBundle hook copies non-bundled files (manifest.json, css) to dist
- @types/chrome provides TypeScript definitions for chrome.* APIs
- Preact with `jsxImportSource: "preact"` in tsconfig works seamlessly as React replacement
- Extension can load without icons - Chrome uses default placeholder icon

## 2025-01-12 - US-011: Background service worker

**Implementation:**
- Enhanced `extension/src/background/index.ts` with full service worker functionality
- Auth state management: AuthState type with isAuthenticated, userId, tenantId, nbConnected, nbNeedsReauth, subscriptionStatus
- Storage functions: getAuthState(), setAuthState(), clearAuthState(), setNbConnection(), setSubscriptionStatus()
- Message handling: GET/SET/CLEAR_AUTH_STATE, SET_NB_CONNECTION, SET_SUBSCRIPTION_STATUS, SUBMIT_QUERY, CANCEL_QUERY, GET_STREAMING_STATE
- SSE connection: parseSSEEvent() and processSSEStream() for Lambda Function URL streaming
- Response broadcasting: broadcastToNbTabs() to all *.nationbuilder.com tabs
- Keepalive: chrome.alarms to prevent MV3 service worker termination during streaming
- Added `alarms` permission to manifest.json

**Learnings:**
- Manifest V3 service workers are ephemeral - they can be killed at any time. Use chrome.alarms as a keepalive mechanism during long-running operations like SSE streaming
- chrome.tabs.query() with url pattern returns all matching tabs; use try/catch when sending messages as content script may not be loaded
- SSE events are separated by double newlines (`\n\n`) - need to buffer and split properly
- chrome.storage.onChanged listener allows syncing auth state changes across tabs automatically
- Service workers don't have persistent state - use chrome.storage.local for anything that needs to survive restarts
- AbortController works in service workers for cancelling fetch requests
- ReadableStreamDefaultReader with TextDecoder handles chunked SSE responses properly

## 2025-01-12 - US-012: Content script and sidebar injection

**Implementation:**
- Enhanced `extension/src/content/index.tsx` with keyboard shortcut handler
- Cmd+K (Mac) / Ctrl+K (Windows/Linux) toggles sidebar open/closed
- Body margin adjusts dynamically (350px open, 40px collapsed) to prevent overlap
- Enhanced `extension/src/components/Sidebar.tsx` with forwardRef and SidebarHandle
- Exposed toggle() method via useImperativeHandle for keyboard shortcut
- Added collapsed state UI showing purple "N" icon with hover effects
- Toggle button includes keyboard shortcut hint in tooltip
- Added CSS for collapsed state in `extension/src/content/content.css`
- Browser tested on nationbuilder.com - all functionality verified

**Learnings:**
- forwardRef + useImperativeHandle in Preact works identically to React for exposing methods
- `navigator.platform.toUpperCase().indexOf('MAC') >= 0` reliably detects Mac for modifier key selection
- Body margin animation syncs with sidebar width transition using same timing (0.2s ease)
- Content script keyboard listeners need event.preventDefault() and event.stopPropagation() to prevent NB shortcuts from interfering
- Playwright can test Chrome extensions using launch_persistent_context with --load-extension arg


## 2025-01-12 - US-013: Chat UI component

**Implementation:**
- Created `extension/src/components/Chat.tsx` - Full chat component with Preact hooks
- Message state management: messages array with id, role, content, timestamp, isStreaming, toolCalls, results
- Text input at bottom with textarea (auto-height), Send button (disabled when empty), Cancel button (during streaming)
- User messages right-aligned with purple background, assistant messages left-aligned with gray background
- Animated typing indicator (3 bouncing dots) shown during streaming
- Person results parsed from STREAMING_TOOL_RESULT events and displayed with name, city/state, "View Profile" link
- Connected to background service worker via chrome.runtime.sendMessage (SUBMIT_QUERY, CANCEL_QUERY)
- Listens for streaming events via chrome.runtime.onMessage (STREAMING_TEXT, STREAMING_TOOL_USE, STREAMING_TOOL_RESULT, STREAMING_ERROR, STREAMING_DONE)
- Updated Sidebar.tsx to import and render Chat component with pageContext prop
- Added 250+ lines of CSS in content.css for chat styles and animations

**Learnings:**
- Chrome extension testing requires persistent context with `--load-extension` flag - MCP Playwright browser doesn't support this
- Preact hooks (useState, useEffect, useRef) work identically to React hooks
- SSE streaming events need to be accumulated during streaming and finalized on STREAMING_DONE
- Person results from tool calls need to be parsed from JSON strings in STREAMING_TOOL_RESULT events
- CSS animations (keyframes) work well for typing indicator - bouncing dots pattern
- textarea rows=1 with CSS max-height creates auto-growing input field effect

## 2025-01-12 - US-014: Auth flow UI screens

**Implementation:**
- Created `extension/src/components/AuthScreen.tsx` with four authentication states:
  - NotLoggedInScreen: "Welcome to Nat" with subscribe button linking to Stripe Checkout
  - NbNotConnectedScreen: "Almost There!" with connect NationBuilder button
  - NbNeedsReauthScreen: Warning banner + "Reconnect Required" with explanation of token expiry
  - SubscriptionLapsedScreen: Error banner + contextual message for cancelled vs payment failed
- Added `useAuthState()` hook that fetches auth state from background worker via GET_AUTH_STATE message and listens for AUTH_STATE_CHANGED updates
- Added `getAuthScreenType()` helper to determine which screen to show based on auth state
- Updated Sidebar.tsx to show loading spinner while fetching auth, AuthScreen if not ready, or Chat if authenticated
- Added 165+ lines of CSS for auth screens with icons, banners, buttons, and hint text

**Learnings:**
- Auth state flow: check isAuthenticated → subscriptionStatus → nbNeedsReauth → nbConnected (order matters)
- useEffect cleanup function needed to remove chrome.runtime.onMessage listener to prevent memory leaks
- SVG icons inline in JSX work well for auth screens - no need for external icon library
- Different subscription statuses (cancelled vs past_due vs unpaid) require different UX messaging
- Placeholder URLs (STRIPE_CHECKOUT_URL, NB_CONNECT_URL) configured as constants for build-time replacement

## 2025-01-12 - US-015: NB page context detection

**Implementation:**
- Created `extension/src/utils/pageContext.ts` with comprehensive page detection utilities
- Person profile detection: `/admin/signups/{id}` - extracts ID from URL, name from DOM (page title, breadcrumbs, profile header)
- List detection: `/admin/lists/{id}` and `/admin/signups?list_id={id}` - extracts list name from DOM
- Event detection: `/admin/sites/{slug}/pages/events/{id}` - extracts event ID and name
- Donation detection: `/admin/finance/donations/{id}` - extracts donation ID and amount from DOM
- Dashboard detection: `/admin` or `/admin/dashboard`
- `getContextDisplayText()` formats context for human-readable display
- `watchForPageChanges()` hooks into History API (pushState/replaceState) and popstate for SPA navigation
- Updated Sidebar component to display context in header with "Viewing: {context}" label
- Updated content script to initialize context detection and pass context on navigation changes
- Context passed with queries to backend via SUBMIT_QUERY message
- Added CSS styling for context display (purple accent on light indigo background)

**Learnings:**
- Chrome extension testing with MCP Playwright isn't possible - requires persistent context with `--load-extension` flag
- NationBuilder admin URLs follow patterns like `/admin/signups/{id}`, `/admin/lists/{id}`, `/admin/sites/{slug}/pages/events/{id}`
- DOM extraction needs multiple fallback selectors since NB admin UI varies - try page title, breadcrumbs, profile headers
- History API hooks (pushState/replaceState override) are the reliable way to detect SPA navigation
- useImperativeHandle can expose multiple methods (toggle, isOpen, setPageContext) for parent component interaction
- PageContext interface should be exported from utils module and imported in components to maintain single source of truth

## 2025-01-12 - US-016: Confirmation dialogs

**Implementation:**
- Backend: Added SSE_EVENT_CONFIRMATION_REQUIRED event type in nat_agent_streaming/handler.py
- Backend: DESTRUCTIVE_TOOLS set flags: delete_signup, delete_contact, delete_donation, delete_event, delete_event_rsvp, delete_path_journey, remove_from_list, update_signup, update_donation, update_event
- Backend: generate_tool_summary() generates human-readable summaries like "Delete person record 12345"
- Backend: confirmed_tools parameter in request body allows re-submitting with user approval
- Extension: ConfirmationDialog.tsx component with icon (delete=red trash, warning=amber triangle, info=blue circle)
- Extension: Dialog shows title, action summary, warning message, and Cancel/Proceed buttons
- Extension: Chat.tsx handles STREAMING_CONFIRMATION_REQUIRED, shows dialog, waits for user response
- Extension: Background worker manages confirmation state (pendingConfirmation, confirmedTools)
- Extension: CONFIRM_ACTION adds toolId to confirmedTools and re-submits query
- Extension: REJECT_ACTION broadcasts STREAMING_DONE with "Action cancelled" message
- CSS: Overlay with fade-in animation, dialog with slide-up animation
- Tests: Fixed missing tenant_id in test_nb_tokens_missing fixture

**Learnings:**
- Confirmation flow requires round-trip: backend sends confirmation_required → client shows dialog → client re-submits with confirmed_tools → backend executes
- Tool ID uses hash of inputs to uniquely identify tool invocations even with same tool name
- StreamingState needs to preserve currentQuery and currentContext for re-submission after confirmation
- Modal overlay should capture clicks to close, but dialog click should not propagate
- Escape key should cancel, Enter key should confirm
## 2025-01-12 - US-017: Session undo

**Implementation:**
- Created `extension/src/utils/undoStack.ts` - Central module for undo tracking
- UndoableAction type: id, timestamp, toolName, toolInput, description, undoType, undoData
- UndoType enum: delete_created, recreate_deleted, restore_updated, remove_from_list, add_to_list, remove_tag, add_tag, not_undoable
- UNDO_CONFIGS maps tool names to their undo configurations (description generator, undoData extractor)
- Uses sessionStorage (clears automatically when tab closes)
- recordAction() stores completed tool actions with undo metadata
- Tracked tools: create_signup, create_contact, create_donation, create_event_rsvp, add_to_list, remove_from_list, add_signup_tagging, remove_signup_tagging
- Chat.tsx imports getUndoStack() and passes stack with SUBMIT_QUERY
- Background worker passes undoStack through to backend
- Backend: _get_undo_instruction() generates human-readable undo instructions
- Backend: stream_agent_response detects undo-related phrases ("undo", "revert", "reverse", "take back", etc.)
- When undo detected and stack not empty, adds context section with recent actions and their undo instructions
- Agent can then follow instructions to call the reverse tool
- 10 unit tests added for _get_undo_instruction()

**Learnings:**
- sessionStorage is perfect for tab-scoped state - clears automatically on close, no cleanup needed
- Undo requires knowing: original action, data needed for reversal, and how to execute reversal
- Some actions can't be undone (deletes without stored data, updates without prior state)
- Passing full undo stack to backend allows agent to see history without frontend parsing
- Undo phrases should be detected case-insensitively with multiple variations
- Context sections in prompt are powerful for giving agent structured knowledge

## 2025-01-12 - US-018: Error handling UI

**Implementation:**
- Created `extension/src/components/ErrorMessage.tsx` with comprehensive error mapping
- `getErrorInfo()` maps error codes to user-friendly messages:
  - NB_NOT_CONNECTED: "Connect your NationBuilder account..."
  - NB_NEEDS_REAUTH: "Your NationBuilder connection has expired..."
  - NB_TOKENS_MISSING, NB_API_ERROR: "NationBuilder isn't responding right now."
  - NB_PERMISSION_ERROR: "Your NB account doesn't have permission..."
  - AGENT_ERROR, CLAUDE_ERROR: "Nat is temporarily unavailable."
  - PAYMENT_REQUIRED, QUERY_LIMIT_EXCEEDED: "You've reached your monthly limit. [Upgrade]"
  - RATE_LIMIT_EXCEEDED: "Please wait X seconds..." (uses retryAfter)
  - CONNECTION_ERROR, NETWORK_ERROR: "Connection to the server was lost..."
  - USER_NOT_FOUND, UNAUTHORIZED: "Your session has expired..."
- ErrorMessage component renders styled cards with icon, title, message, optional action button
- Three variants: error (red), warning (amber), info (blue)
- Added Message.errorDetails interface for storing error info
- Updated Chat.tsx STREAMING_ERROR handler to use errorDetails
- Updated submitQuery catch blocks to map common errors to error codes
- Added 129 lines of CSS for error message styling

**Learnings:**
- Mapping error codes to user-friendly messages centralizes error UX in one place
- Including both a title and message helps users quickly understand what happened
- Action buttons (like "Upgrade Plan") give users a clear path forward
- Different visual variants (error/warning/info) help convey severity without alarming users unnecessarily
- Rate limit errors benefit from showing the actual wait time via retryAfter parameter
- Catching unknown errors and trying to infer context (e.g., checking if "nationbuilder" is in error message) provides better fallback UX

## 2025-01-12 - US-019: Tutorial walkthrough

**Implementation:**
- Created `extension/src/components/Tutorial.tsx` with 4-step guided walkthrough
- Step 1: "Welcome to Nat!" - Introduces Nat as AI assistant for NationBuilder
- Step 2: "What Nat Can Do" - Shows 4 example queries (donors, volunteers, lists, events)
- Step 3: "Getting Help" - Explains natural language queries with examples
- Step 4: "Confirmations & Safety" - Reassures users about data protection
- Tutorial completion stored in `chrome.storage.local` with key `nat_tutorial_completed`
- `useTutorialState()` hook checks storage and exposes showTutorial/completeTutorial
- Sidebar.tsx shows tutorial when user is authenticated but hasn't completed tutorial
- Skip button available on every step (calls handleComplete immediately)
- Keyboard navigation: Enter/ArrowRight (next), ArrowLeft (back), Escape (skip)
- Progress dots allow clicking to any step
- "Get Started" button on final step
- 180 lines CSS with bounce animation for icon, fade animation for content

**Learnings:**
- Pattern: Show onboarding AFTER auth flow completes but BEFORE main UI renders
- Using `chrome.storage.local` is appropriate for tutorial state (persists across sessions)
- `useTutorialState` hook pattern mirrors `useAuthState` pattern - fetch async then update state
- JSX.Element type must be imported from 'preact' explicitly for TypeScript
- Chrome extension testing with Playwright requires persistent context + --load-extension flag (not supported in standard Playwright)
- Loading state should combine auth loading AND tutorial loading to avoid flicker
- Conditional rendering order matters: loading → tutorial → chat ensures smooth UX

## 2025-01-12 - US-020: Landing page with pricing

**Implementation:**
- Created `site/` directory with Vite + TypeScript build setup
- `index.html` - Full landing page with semantic HTML sections:
  - Hero: Value proposition headline, subtitle, CTAs, browser mockup showing Nat sidebar on NB
  - Features: 6 cards (Natural Conversation, Full People Access, Smart Lists & Tags, Donation Tracking, Event Management, Safe & Secure)
  - How It Works: 3-step flow (Subscribe & Install, Connect NB, Start Asking)
  - Pricing: 3-tier cards (Starter $49/1/500, Team $149/5/2000, Organization $399/15/5000) + comparison table
  - FAQ: 6 common questions with answers
  - CTA: Final call to action section
  - Footer: Product links, legal links, support contact
- `src/styles.css` - 700+ lines CSS with:
  - CSS variables for colors, shadows, typography
  - Mobile-first responsive design with breakpoints at 1024px, 768px, 480px
  - Feature card hover effects, pricing card featured state
  - Typing indicator animation in browser mockup
- `src/main.ts` - Minimal JavaScript for mobile menu toggle, smooth scrolling, intersection observer for active nav
- Subscribe buttons link to placeholder Stripe URLs (`https://buy.stripe.com/starter`, etc.)
- Updated `.gitignore` to exclude `node_modules/` and `.playwright-mcp/`

**Learnings:**
- Vite builds static sites extremely fast - 44ms for production build
- Inter font from Google Fonts provides professional typography without custom font files
- CSS `gradient-text` effect using background-clip works well for hero headlines
- Intersection Observer API enables "active" state on nav links during scroll without scroll event listeners
- Mobile menu toggle with hamburger animation is straightforward with CSS transitions
- Feature comparison tables need `overflow-x: auto` wrapper for mobile scrolling
- Browser mockup with CSS (no images) is lightweight and scales perfectly

